import{$f as I,B as p,H as v,I as S,Od as i,P as h,Se as _,Ue as j,W as T,Z as M,b as g,e as l,m as u,q as c,rd as A,w as k}from"./chunk-MDNBQXON.js";import{a as r,b as n}from"./chunk-SEDBTTTN.js";var b=class{constructor(){this.internetConnection=!0;this.serverConnection=!0}};var y=class{constructor(){this.dataMenu="";this.themeMode="system";this.themeDirection="rtl";this.themeFontSize=0;this.themeLanguage="fa";this.themeHighlight="blue";this.themeMenuPin=[];this.innerWidth=0;this.innerHeight=0;this.mainPagePreloaderShow=!0;this.actionScrollTopPage=!1;this.actionScrollTopList=!1}};var m={tokenInfoStore:void 0,deviceTokenInfoStore:new _,processInfoStore:new Map,processOrderStore:[],coreSiteResultStore:new i,coreModuleResultStore:new i,coreCpMainResultStore:new i,enumRecordStatusResultStore:new i,currencyResultStore:new i,connectionStatusStore:new b,themeStore:new y};function w(o=m,e){switch(e.type){case f:return n(r({},o),{tokenInfoStore:e.payload});case L:return n(r({},o),{deviceTokenInfoStore:e.payload});case D:return n(r({},o),{processInfoStore:e.payload});case P:return n(r({},o),{processOrderStore:e.payload});case C:return n(r({},o),{coreSiteResultStore:e.payload});case U:return n(r({},o),{coreModuleResultStore:e.payload});case x:return n(r({},o),{coreCpMainResultStore:e.payload});case W:return n(r({},o),{currencyResultStore:e.payload});case J:return n(r({},o),{enumRecordStatusResultStore:e.payload});case F:return n(r({},o),{connectionStatusStore:e.payload});case R:return n(r({},o),{themeStore:e.payload});default:return m}}var f="SET_TOKEN_INFO",L="SET_TOKEN_DEVICE",D="SET_Process_Info",P="SET_Process_Order",C="SET_Core_Site",U="SET_Core_Module",x="SET_CpMain_Menu",W="SET_Core_Currency",J="SET_Info_Enum",F="SET_Connection_STATE",R="SET_Theme_STATE";var a=class a{constructor(){this.stateSubject=new l(m);this.state=m,window.getInfo=()=>this.state}get getStateAll(){return this.state}getStateSnapshot(){return this.stateSubject.getValue()}setState(e){Object.assign(this.state,w(this.state,e)),this.stateSubject.next(this.state)}getState(e){if(typeof e!="function")throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return this.stateSubject.asObservable().pipe(c(e)).pipe(v())}getStateDirect(){return this.stateSubject.pipe(v())}static forRoot(){return{ngModule:a,providers:[]}}};a.\u0275fac=function(t){return new(t||a)},a.\u0275prov=T({token:a,factory:a.\u0275fac,providedIn:"root"});var E=a;var d=class d{constructor(e,t,s){this.router=e;this.authService=t;this.cmsStoreService=s;this.unsubscribe=[];this.currentUser$=new g;this.currentUserSubject=new l(new I);this.isLoading$=new g;this.isLoadingSubject=new l(!1);this.isLoadingSubject=new l(!1),this.currentUserSubject=new l(void 0),this.currentUser$=this.currentUserSubject.asObservable(),this.isLoading$=this.isLoadingSubject.asObservable()}get currentUserValue(){return this.currentUserSubject.value}set currentUserValue(e){this.currentUserSubject.next(e)}getTokenInfoType(){let e=this.authService.getJWT();return!e||!e.accessToken?u(void 0):(this.isLoadingSubject.next(!0),this.authService.ServiceCurrentToken().pipe(c(t=>(t.isSuccess?(this.currentUserSubject.next(t.item),this.cmsStoreService.setState({type:f,payload:t.item})):this.logout(),t.item)),p(t=>u("error",t)),S(()=>this.isLoadingSubject.next(!1))))}getTokenInfo(){let e=this.authService.getJWT();return!e||!e.accessToken?u(void 0):(this.isLoadingSubject.next(!0),this.authService.ServiceCurrentToken().pipe(c(t=>(t.isSuccess?(this.currentUserSubject.next(t.item),this.cmsStoreService.setState({type:f,payload:t.item}),t.item.access&&(t.item.access.direction=="ltr"?this.cmsStoreService.getStateAll.themeStore.themeDirection="ltr":this.cmsStoreService.getStateAll.themeStore.themeDirection="rtl",t.item.access.language?.length>0&&(this.cmsStoreService.getStateAll.themeStore.themeLanguage=t.item.access.language),this.cmsStoreService.setState({type:R,payload:this.cmsStoreService.getStateAll.themeStore}))):this.logout(),t)),S(()=>this.isLoadingSubject.next(!1))))}login(e){return this.isLoadingSubject.next(!0),this.authService.ServiceSigninUser(e).pipe(c(t=>{let s=this.setAuthFromLocalStorage(t.item);return this.callRefreshToken(t.item),s}),h(()=>this.getTokenInfo()),p(t=>(console.error("err",t),u(void 0))),S(()=>this.isLoadingSubject.next(!1)))}logout(){this.cmsStoreService.setState({type:f,payload:new I}),this.cmsStoreService.setState({type:C,payload:new i}),this.cmsStoreService.setState({type:x,payload:new i}),this.authService.setJWT(null),this.authService.ServiceLogout(),this.router.navigate(["/auth/login"],{queryParams:{}})}setAuthFromLocalStorage(e){return!!(e&&e.accessToken)}selectLanguage(e){this.isLoadingSubject.next(!0);var t={lang:e,refreshToken:this.authService.getJWT()?.refreshToken,userId:this.currentUserValue.access.userId,siteId:this.currentUserValue.access.siteId,userAccessAdminAllowToProfessionalData:this.currentUserValue.access.userAccessAdminAllowToProfessionalData,userAccessAdminAllowToAllData:this.currentUserValue.access.userAccessAdminAllowToAllData};return this.authService.ServiceRefreshToken(t).pipe(c(s=>{let V=this.setAuthFromLocalStorage(s.item);return this.callRefreshToken(s.item),V}),h(()=>this.getTokenInfoType()),p(s=>(console.error("err",s),u(void 0))),S(()=>this.isLoadingSubject.next(!1)))}callRefreshToken(e){this.diffSecondsSubscribe&&this.diffSecondsSubscribe.unsubscribe();var t=new Date(e.tokenExpireDate).getTime()-new Date().getTime();t>1e5&&(t=t-1e5),console.log("token expire seconds",t),this.diffSecondsSubscribe=k(t).subscribe(s=>{this.refreshToken()})}refreshToken(e){return this.isLoadingSubject.next(!0),this.authService.ServiceRefreshToken(e).pipe(c(t=>this.setAuthFromLocalStorage(t.item)),h(()=>this.getTokenInfo()),p(t=>(console.error("err",t),u(void 0))),S(()=>this.isLoadingSubject.next(!1)))}ngOnDestroy(){this.unsubscribe.forEach(e=>e.unsubscribe()),this.diffSecondsSubscribe&&this.diffSecondsSubscribe.unsubscribe()}};d.\u0275fac=function(t){return new(t||d)(M(A),M(j),M(E))},d.\u0275prov=T({token:d,factory:d.\u0275fac,providedIn:"root"});var O=d;export{b as a,y as b,f as c,L as d,D as e,P as f,U as g,x as h,W as i,J as j,F as k,R as l,E as m,O as n};
