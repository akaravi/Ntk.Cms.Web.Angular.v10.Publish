import{B as p,H as v,I as S,P as h,Pd as c,Te as _,Ve as j,W as T,Z as M,ag as I,b as g,e as u,m as i,q as a,qd as A,w as k}from"./chunk-7PG6FQZE.js";import{a as r,b as n}from"./chunk-SEDBTTTN.js";var b=class{constructor(){this.internetConnection=!0;this.serverConnection=!0}};var y=class{constructor(){this.dataMenu="";this.themeMode="system";this.themeDirection="rtl";this.themeFontSize=0;this.themeLanguage="fa";this.themeHighlight="blue";this.themeMenuPin=[];this.innerWidth=0;this.innerHeight=0;this.mainPagePreloaderShow=!0;this.actionScrollTopPage=!1;this.actionScrollTopList=!1}};var f={tokenInfoStore:void 0,deviceTokenInfoStore:new _,processInfoStore:new Map,processOrderStore:[],coreSiteResultStore:new c,coreModuleResultStore:new c,coreCpMainResultStore:new c,enumRecordStatusResultStore:new c,currencyResultStore:new c,connectionStatusStore:new b,themeStore:new y};function w(o=f,e){switch(e.type){case m:return n(r({},o),{tokenInfoStore:e.payload});case L:return n(r({},o),{deviceTokenInfoStore:e.payload});case P:return n(r({},o),{processInfoStore:e.payload});case D:return n(r({},o),{processOrderStore:e.payload});case C:return n(r({},o),{coreSiteResultStore:e.payload});case U:return n(r({},o),{coreModuleResultStore:e.payload});case x:return n(r({},o),{coreCpMainResultStore:e.payload});case W:return n(r({},o),{currencyResultStore:e.payload});case J:return n(r({},o),{enumRecordStatusResultStore:e.payload});case F:return n(r({},o),{connectionStatusStore:e.payload});case R:return n(r({},o),{themeStore:e.payload});default:return f}}var m="SET_TOKEN_INFO",L="SET_TOKEN_DEVICE",P="SET_Process_Info",D="SET_Process_Order",C="SET_Core_Site",U="SET_Core_Module",x="SET_CpMain_Menu",W="SET_Core_Currency",J="SET_Info_Enum",F="SET_Connection_STATE",R="SET_Theme_STATE";var l=class l{constructor(){this.stateSubject=new u(f);this.state=f,window.getInfo=()=>this.state}get getStateAll(){return this.state}getStateSnapshot(){return this.stateSubject.getValue()}setState(e){Object.assign(this.state,w(this.state,e)),this.stateSubject.next(this.state)}getState(e){if(typeof e!="function")throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return this.stateSubject.asObservable().pipe(a(e)).pipe(v())}getStateDirect(){return this.stateSubject.pipe(v())}static forRoot(){return{ngModule:l,providers:[]}}};l.\u0275fac=function(t){return new(t||l)},l.\u0275prov=T({token:l,factory:l.\u0275fac,providedIn:"root"});var E=l;var d=class d{constructor(e,t,s){this.router=e;this.authService=t;this.cmsStoreService=s;this.unsubscribe=[];this.currentUser$=new g;this.currentUserSubject=new u(new I);this.isLoading$=new g;this.isLoadingSubject=new u(!1);this.isLoadingSubject=new u(!1),this.currentUserSubject=new u(void 0),this.currentUser$=this.currentUserSubject.asObservable(),this.isLoading$=this.isLoadingSubject.asObservable()}get currentUserValue(){return this.currentUserSubject.value}set currentUserValue(e){this.currentUserSubject.next(e)}getTokenInfoType(){let e=this.authService.getJWT();return!e||!e.accessToken?i(void 0):(this.isLoadingSubject.next(!0),this.authService.ServiceCurrentToken().pipe(a(t=>(t.isSuccess?(this.currentUserSubject.next(t.item),this.cmsStoreService.setState({type:m,payload:t.item})):this.router.navigate(["/auth/login"],{queryParams:{}}),t.item)),p(t=>i("error",t)),S(()=>this.isLoadingSubject.next(!1))))}getTokenInfo(){let e=this.authService.getJWT();return!e||!e.accessToken?i(void 0):(this.isLoadingSubject.next(!0),this.authService.ServiceCurrentToken().pipe(a(t=>(t?.isSuccess?(this.currentUserSubject.next(t.item),this.cmsStoreService.setState({type:m,payload:t.item}),t.item.access&&(t.item.access.direction=="ltr"?this.cmsStoreService.getStateAll.themeStore.themeDirection="ltr":this.cmsStoreService.getStateAll.themeStore.themeDirection="rtl",t.item.access.language?.length>0&&(this.cmsStoreService.getStateAll.themeStore.themeLanguage=t.item.access.language),this.cmsStoreService.setState({type:R,payload:this.cmsStoreService.getStateAll.themeStore}))):this.router.navigate(["/auth/login"],{queryParams:{}}),t)),S(()=>this.isLoadingSubject.next(!1))))}login(e){return this.isLoadingSubject.next(!0),this.authService.ServiceSigninUser(e).pipe(a(t=>{if(t){let s=this.setAuthFromLocalStorage(t.item);return this.callRefreshToken(t.item),s}return i(void 0)}),h(()=>this.getTokenInfo()),p(t=>(console.error("err",t),i(void 0))),S(()=>this.isLoadingSubject.next(!1)))}logout(){this.authService.ServiceCurrentToken().subscribe({next:e=>{this.cmsStoreService.setState({type:m,payload:new I}),this.cmsStoreService.setState({type:C,payload:new c}),this.cmsStoreService.setState({type:x,payload:new c}),this.authService.setJWT(null),this.router.navigate(["/auth"],{queryParams:{}})}})}setAuthFromLocalStorage(e){return!!(e&&e.accessToken)}selectLanguage(e){this.isLoadingSubject.next(!0);var t={lang:e,refreshToken:this.authService.getJWT()?.refreshToken,userId:this.currentUserValue.access.userId,siteId:this.currentUserValue.access.siteId,userAccessAdminAllowToProfessionalData:this.currentUserValue.access.userAccessAdminAllowToProfessionalData,userAccessAdminAllowToAllData:this.currentUserValue.access.userAccessAdminAllowToAllData};return this.authService.ServiceRefreshToken(t).pipe(a(s=>{if(s){let V=this.setAuthFromLocalStorage(s.item);return this.callRefreshToken(s.item),V}return i(void 0)}),h(()=>this.getTokenInfoType()),p(s=>(console.error("err",s),i(void 0))),S(()=>this.isLoadingSubject.next(!1)))}callRefreshToken(e){this.diffSecondsSubscribe&&this.diffSecondsSubscribe.unsubscribe();var t=new Date(e.tokenExpireDate).getTime()-new Date().getTime();t>1e5&&(t=t-1e5),console.log("token expire seconds",t),this.diffSecondsSubscribe=k(t).subscribe(s=>{this.refreshToken()})}refreshToken(e){return this.isLoadingSubject.next(!0),this.authService.ServiceRefreshToken(e).pipe(a(t=>t?this.setAuthFromLocalStorage(t.item):i(void 0)),h(()=>this.getTokenInfo()),p(t=>i(void 0)),S(()=>this.isLoadingSubject.next(!1)))}ngOnDestroy(){this.unsubscribe.forEach(e=>e.unsubscribe()),this.diffSecondsSubscribe&&this.diffSecondsSubscribe.unsubscribe()}};d.\u0275fac=function(t){return new(t||d)(M(A),M(j),M(E))},d.\u0275prov=T({token:d,factory:d.\u0275fac,providedIn:"root"});var O=d;export{b as a,y as b,m as c,L as d,P as e,D as f,U as g,x as h,W as i,J as j,F as k,R as l,E as m,O as n};
